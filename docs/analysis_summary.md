# Project Analysis Summary

This document provides a summary of the analyses conducted within this project, based on the scripts and notebooks found in the `src/` and `notebook/` directories. The primary datasets used appear to be `toxprot_2017.csv` and `toxprot_2025.csv`, likely representing snapshots of a toxin-related protein database at two different time points.

## Data Processing and Preparation

### 1. SwissProt Data Parsing (`src/parse_sprot_dat.py`)
- **Purpose**: This script is designed to parse a raw UniProtKB/SwissProt data file (e.g., `201711_sprot.dat`, `sprot_202501.dat`).
- **Functionality**:
    - It filters for entries matching a specific query related to Metazoa (taxonomy_id:33208) and toxin-related terms (tissue specificity: venom, or keyword: Toxin KW-0800).
    - Extracts a comprehensive list of fields for each matching protein entry, including:
        - Basic identifiers (Entry, Entry Name, Organism, Organism ID)
        - Protein characteristics (Protein names, Protein families (capitalized and with improved extraction logic), Length, Mass)
        - Functional annotations (Function [CC], Tissue specificity, Toxic dose)
        - Post-translational modifications (Disulfide bond, Glycosylation, PTM, Signal peptide, Propeptide)
        - Cross-references (InterPro, Pfam, KEGG, Gene Ontology terms split by P/C/F)
        - Full sequence.
    - **Signal Peptide Processing**: Identifies signal peptide regions to extract and store only the mature protein sequence.
    - Handles multi-line fields and specific formatting within SwissProt entries.
    - Outputs the extracted data into a Tab-Separated Values (TSV) file and mature protein sequences into FASTA files.
- **Example Usage**: `python parse_sprot_dat.py data/raw/201711_sprot.dat data/interim/toxprot_2017.tsv` (similar for 2025 data)
- **Likely Output**:
    - `toxprot_2017.csv` and `toxprot_2025.csv` files in `data/processed/` (derived from TSV).
    - `toxprot_2017_mature.fasta` and `toxprot_2025_mature.fasta` in `data/processed/`.

### 2. Data Cleaning (`notebook/clean_data.ipynb`)
- **Purpose**: As suggested by its name, this Jupyter notebook likely contains steps for cleaning and preparing the parsed data (e.g., the TSV/CSV files generated by `parse_sprot_dat.py`).
- **Functionality (Inferred)**:
    - Handling missing values.
    - Standardizing fields (e.g., protein family names, habitat classifications).
    - Deriving new features or columns if necessary.
    - Filtering out irrelevant entries.
- **Output**: Cleaned datasets, presumably `toxprot_2017.csv` and `toxprot_2025.csv` in `data/processed/`, which serve as input for downstream analyses.

### 3. Protein Sequence Embedding (`src/generate_protT5_embeddings.py` - hypothetical name)
- **Purpose**: To generate fixed-length vector representations (embeddings) for protein sequences using the ProtT5 model.
- **Functionality**:
    - Takes FASTA files of mature protein sequences as input.
    - Utilizes a pre-trained ProtT5 model to compute embeddings for each sequence.
    - Saves these embeddings, typically as `.h5` files.
    - These embeddings can be used for various downstream machine learning tasks, including similarity searches and visualization.
- **Data Management**:
    - Raw SwissProt data for 2025 (`sprot_202501.dat`) has been added to `data/raw/`.
    - ProtT5 embeddings for 2017 and 2025 datasets are generated. `.gitattributes` was used for LFS tracking of these potentially large embedding files.
- **Output**: `protT5_embeddings_2017.h5` and `protT5_embeddings_2025.h5` (example names) likely stored in `data/processed/embeddings/`.

## Comparative Analyses (2017 vs. 2025 Datasets)

The project involves several scripts and notebooks dedicated to comparing the 2017 and 2025 datasets.

### 1. Taxonomic Analysis and Plotting (`src/taxa_plots_script.py`)
- **Purpose**: This script performs a comparative taxonomic analysis between the `toxprot_2017.csv` and `toxprot_2025.csv` datasets.
- **Key Updates & Analyses**:
    - **Species Extraction**: Updated species extraction logic during preprocessing.
    - **Taxonomic Resolution**: Parses full taxonomy to extract Order, Family, and Genus levels for more detailed analysis.
    - **Counting**: Generates count tables by species (rather than `scientific_name`).
- **Key Analyses & Outputs**:
    - **Top 5 Taxa Distribution**:
        - Compares the distribution of the top 5 taxa (at the "Order" level) between the 2017 and 2025 datasets.
        - Others are grouped into an "Others" category.
        - Output: Stacked bar plot saved as `figures/taxa/top_taxa_distribution.png`.
    - **Newcomer Taxa Orders**:
        - Identifies taxonomic "Orders" present in the 2025 dataset but absent in the 2017 dataset.
        - Plots the count of entries for these newcomer orders (top 15 shown).
        - Output: Horizontal bar plot saved as `figures/taxa/taxa_newcomers_order.png`.
    - **Newcomer Taxa Families**:
        - Similar to the above, but at the "Family" level.
        - Identifies and plots newcomer families (top 15 shown).
        - Output: Horizontal bar plot saved as `figures/taxa/taxa_newcomers_family.png`.
- **Data Source**: `data/processed/toxprot_2017.csv` and `data/processed/toxprot_2025.csv`.

### 2. Habitat and Protein Family Change Visualization (`src/visualize_habitat_protein_changes.py`)
- **Purpose**: This script provides a detailed analysis of changes in protein family representation within "terrestrial" versus "marine" habitats, comparing the 2017 and 2025 datasets. It specifically focuses on protein families present in *both* habitats ("dual-habitat families").
- **Key Updates & Analyses**:
    - **Figure Restructuring**: Habitat-related figures have been restructured for clarity.
    - **Alternative Plots**: Generation of several alternative habitat representation plots to explore data from different perspectives.
    - **Habitat Specificity**: Differentiates between marine and terrestrial species in its analysis.
- **Key Analyses & Outputs**:
    - **Overall Habitat Distribution**:
        - Generates a 100% stacked bar chart showing the relative proportion of terrestrial vs. marine sequences for dual-habitat families in 2017 and 2025.
        - Output: `figures/habitat/1_stacked_bar_habitat_vs_year_mpl.png`.
    - **Percentage Increase by Habitat**:
        - Calculates and plots the overall percentage increase of sequences from 2017 to 2025, separately for terrestrial and marine habitats (for dual-habitat families).
        - Output: `figures/habitat/2_percentage_increase_by_habitat_mpl.png`.
    - **Heatmap of Percentage Increase**:
        - Creates a heatmap showing the percentage increase for the top N (default 15) dual-habitat protein families, broken down by terrestrial and marine habitats.
        - Cells are annotated with percentage change and absolute count changes.
        - Output: `figures/habitat/5_heatmap_percentage_increase_mpl.png`.
    - **Diverging Bar Charts for Protein Families (Top N)**:
        - **Absolute Change**: Shows absolute change in sequence counts (2025 vs 2017) for terrestrial and marine habitats.
          Output: `figures/habitat/6a_diverging_bar_abs_change_protein_family_mpl.png`.
        - **Percentage Change**: Shows percentage change, with plot values capped at +/-100% but actual values annotated.
          Output: `figures/habitat/6b_diverging_bar_perc_change_protein_family_mpl.png`.
        - **Current Absolute Numbers (2025)**: Shows absolute numbers of sequences in 2025 for terrestrial and marine, with 2017->2025 change annotated.
          Output: `figures/habitat/6c_diverging_bar_abs_numbers_protein_family_mpl.png`.
    - **Summary CSV**:
        - Generates a CSV file (`dual_habitat_protein_counts_summary.csv` in `figures/habitat/`) detailing counts for each dual-habitat protein family per habitat and year.
- **Data Source**: `data/processed/toxprot_2017.csv` and `data/processed/toxprot_2025.csv`.

### 3. Protein Family Renaming Report (`src/generate_family_renaming_report.py`)
- **Purpose**: This script identifies potential renamings of protein families by tracking the "Protein families" field for identical "Entry" identifiers between the 2017 and 2025 datasets.
- **Functionality Updates**:
    - **Simplified Logic**: The protein family extraction logic for the report has been simplified.
- **Output**: A CSV file named `protein_family_renaming.csv` saved in the `out/` directory, listing:
    - `Old_Family_Name_2017`
    - `New_Family_Name_2025`
    - `Entries_Supporting_Rename`
    - `Old_Family_Global_Count_2017`
    - `New_Family_Global_Count_2025`
- **Data Source**: `data/processed/toxprot_2017.csv` and `data/processed/toxprot_2025.csv`.

### 4. Other Notebooks for Comparison and Figure Generation
- **`notebook/protfam_figures.ipynb`**:
    - **Inferred Purpose**: Likely dedicated to generating various figures related to protein families, possibly exploring distributions, characteristics, or comparisons not covered by the Python scripts. Includes updates like consistent color ordering in stacked bar plots and specific adjustments to length distribution and Pfam plots.
- **`notebook/kim_vs_sprot2017.ipynb`**:
    - **Inferred Purpose**: Suggests a specific comparative analysis. This notebook likely compares a dataset referred to as "Kim" (details unknown from file structure alone) against the `toxprot_2017` (SwissProt 2017) dataset. The nature of this comparison would be detailed within the notebook.

### 5. Protein Space Visualization (ProtSpace Integration)
- **Purpose**: To prepare data for visualization of protein relationships in a 2D embedding space using the ProtSpace visualizer.
- **Functionality**:
    - Involves preparing and structuring data (likely protein embeddings and metadata) into a `protspace.json` file format.
    - This JSON file will serve as the input for the ProtSpace tool, allowing for interactive exploration of protein clusters and relationships.
- **Status**: Preparatory work for `protspace.json` creation is complete.

## Summary of Outputs
The analyses generate several key outputs:

- **Processed Data**:
    - `data/processed/toxprot_2017.csv`
    - `data/processed/toxprot_2025.csv`
    - `data/interim/toxprot_2017.fasta`
    - `data/interim/toxprot_2025.fasta`
    - `data/processed/protspace/toxprot_2017.h5`
    - `data/processed/protspace/toxprot_2025.h5`
    - (Potentially other interim files from `notebook/clean_data.ipynb`)
- **Figures**:
    - Located in `figures/taxa/` (taxonomic comparison plots)
    - Located in `figures/habitat/` (habitat-specific protein family change plots)
    - (Potentially other figures from `notebook/protfam_figures.ipynb`)
- **Reports/Summaries**:
    - `out/protein_family_renaming.csv` (report on potential family name changes)
    - `figures/habitat/dual_habitat_protein_counts_summary.csv` (summary of protein counts for dual-habitat families)
- **Visualization Files**:
    - `protspace.json` (planned output for ProtSpace visualization)

## Overall Workflow Inference
1.  Raw SwissProt data (e.g., `201711_sprot.dat` and `sprot_202501.dat`) is parsed using `src/parse_sprot_dat.py` to extract relevant toxin/venom protein entries into TSV format and mature protein sequences into FASTA format (after signal peptide removal).
2.  The `notebook/clean_data.ipynb` is used to clean and preprocess these TSV datasets, resulting in `toxprot_2017.csv` and `toxprot_2025.csv`.
3.  Mature FASTA sequences are used to generate ProtT5 embeddings (e.g., via a script like `src/generate_protT5_embeddings.py`).
4.  These cleaned datasets and embeddings are then used as input for various comparative analyses and data generation:
    - Taxonomic changes (`src/taxa_plots_script.py`), including parsing to Order, Family, Genus and updated species counting.
    - Changes in protein family representation across marine/terrestrial habitats (`src/visualize_habitat_protein_changes.py`), with restructured figures and alternative plots.
    - Identification of protein family renamings (`src/generate_family_renaming_report.py`) with simplified logic.
    - Preparation of `protspace.json` for 2D embedding visualization with ProtSpace.
    - Further specialized comparisons and figure generation (`notebook/protfam_figures.ipynb`, `notebook/kim_vs_sprot2017.ipynb`).
5.  Results are saved as plots in the `figures/` subdirectories, data reports in `out/` or `figures/habitat/`, and visualization files like `protspace.json`.

This project provides a comprehensive comparative analysis of toxin-related protein datasets from two time points, focusing on taxonomic shifts, habitat-specific changes, data curation aspects like family renamings, and increasingly leveraging protein embeddings for advanced analysis and visualization.